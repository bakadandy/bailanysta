<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connections - Bailanysta</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Custom CSS -->
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="{% url 'core:home' %}">Bailanysta</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'core:home' %}">Home</a>
                    </li>
                    {% if user.is_authenticated %}
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'users:profile' user.username %}">Profile</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="{% url 'users:connections' %}">Connections</a>
                    </li>
                    {% endif %}
                </ul>
                <ul class="navbar-nav">
                    {% if user.is_authenticated %}
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'users:profile' user.username %}">{{ user.username }}</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'users:logout' %}">Logout</a>
                        </li>
                    {% else %}
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'users:login' %}">Login</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'users:register' %}">Register</a>
                        </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container my-4">
        <div class="row">
            <!-- Left Sidebar - User Profile Summary -->
            <div class="col-md-3 mb-4">
                <div class="card">
                    <div class="card-body text-center">
                        {% if user.profile_picture %}
                            <img src="{{ user.profile_picture.url }}" class="rounded-circle profile-picture mb-3" alt="Profile Picture" style="width: 100px; height: 100px; object-fit: cover;">
                        {% else %}
                            <img src="{% static 'img/default-avatar.png' %}" class="rounded-circle profile-picture mb-3" alt="Default Profile Picture" style="width: 100px; height: 100px; object-fit: cover;">
                        {% endif %}
                        <h5>{{ user.nickname|default:user.username }}</h5>
                        <p class="text-muted">@{{ user.username }}</p>
                        <div class="d-flex justify-content-around mt-3">
                            <div>
                                <h5 id="followersCount">{{ user.user_followers.count }}</h5>
                                <small class="text-muted">Followers</small>
                            </div>
                            <div>
                                <h5 id="followingCount">{{ user.user_following.count }}</h5>
                                <small class="text-muted">Following</small>
                            </div>
                        </div>
                        <a href="{% url 'users:profile' user.username %}" class="btn btn-outline-primary mt-3 w-100">View Profile</a>
                    </div>
                </div>
            </div>

            <!-- Main Content - Connections -->
            <div class="col-md-9">
                <div class="card">
                    <div class="card-header">
                        <ul class="nav nav-tabs card-header-tabs" id="connectionTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="followers-tab" data-bs-toggle="tab" data-bs-target="#followers" type="button" role="tab" aria-controls="followers" aria-selected="true">Followers</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="following-tab" data-bs-toggle="tab" data-bs-target="#following" type="button" role="tab" aria-controls="following" aria-selected="false">Following</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="discover-tab" data-bs-toggle="tab" data-bs-target="#discover" type="button" role="tab" aria-controls="discover" aria-selected="false">Discover People</button>
                            </li>
                        </ul>
                    </div>
                    <div class="card-body">
                        <div class="tab-content" id="connectionTabsContent">
                            <!-- Followers Tab -->
                            <div class="tab-pane fade show active" id="followers" role="tabpanel" aria-labelledby="followers-tab">
                                <div class="row" id="followersList">
                                    <div class="col-12 text-center py-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p class="mt-2">Loading followers...</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Following Tab -->
                            <div class="tab-pane fade" id="following" role="tabpanel" aria-labelledby="following-tab">
                                <div class="row" id="followingList">
                                    <div class="col-12 text-center py-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p class="mt-2">Loading following...</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Discover Tab -->
                            <div class="tab-pane fade" id="discover" role="tabpanel" aria-labelledby="discover-tab">
                                <div class="mb-3">
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="searchInput" placeholder="Search for users...">
                                        <button class="btn btn-primary" id="searchButton">
                                            <i class="fas fa-search"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="row" id="discoverList">
                                    <div class="col-12 text-center py-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p class="mt-2">Loading suggestions...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Network Visualization -->
                <div class="card mt-4">
                    <div class="card-header">
                        <h5 class="mb-0">Your Network</h5>
                    </div>
                    <div class="card-body">
                        <div id="networkVisualization" style="height: 400px; width: 100%;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User data for JavaScript -->
    <div id="userData" 
         data-user-id="{{ user.id }}" 
         data-user-nickname="{{ user.nickname|default:user.username }}" 
         data-user-profile-picture="{{ user.profile_picture.url|default:'/static/img/default-avatar.png' }}" 
         style="display: none;"></div>

    <!-- Footer -->
    <footer class="bg-light text-center text-muted py-4 mt-5">
        <div class="container">
            <p>Â© 2025 Bailanysta - Connect with friends and the world around you.</p>
        </div>
    </footer>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Vis.js for Network Visualization -->
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <!-- Custom JavaScript -->
    <script>
        // Get user data from HTML data attributes
        const userData = document.getElementById('userData');
        const currentUserId = parseInt(userData.getAttribute('data-user-id'));
        const currentUserNickname = userData.getAttribute('data-user-nickname');
        const currentUserProfilePicture = userData.getAttribute('data-user-profile-picture');

        // Initialize dark mode if enabled
        function initTheme() {
            const darkMode = localStorage.getItem('darkMode') === 'true';
            if (darkMode) {
                document.body.classList.add('dark-mode');
            }
        }
        
        // Initialize theme on page load
        initTheme();
        
        document.addEventListener('DOMContentLoaded', function() {
            // Load followers
            loadFollowers();
            
            // Add tab change event to load data when tab is activated
            document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(tab => {
                tab.addEventListener('shown.bs.tab', function(e) {
                    const targetId = e.target.getAttribute('data-bs-target').substring(1);
                    if (targetId === 'followers') {
                        loadFollowers();
                    } else if (targetId === 'following') {
                        loadFollowing();
                    } else if (targetId === 'discover') {
                        loadDiscoverUsers();
                    }
                });
            });
            
            // Search functionality
            document.getElementById('searchButton').addEventListener('click', function() {
                const searchTerm = document.getElementById('searchInput').value.trim();
                if (searchTerm) {
                    searchUsers(searchTerm);
                }
            });
            
            // Search on Enter key
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const searchTerm = this.value.trim();
                    if (searchTerm) {
                        searchUsers(searchTerm);
                    }
                }
            });
            
            // Initialize network visualization
            initializeNetwork();
        });
        
        // Function to load followers
        function loadFollowers() {
            fetch(`/api/users/${currentUserId}/followers/`)
                .then(response => response.json())
                .then(users => {
                    displayUsers('followersList', users);
                })
                .catch(error => {
                    console.error('Error fetching followers:', error);
                    document.getElementById('followersList').innerHTML = '<div class="col-12 text-center py-4">Error loading followers. Please try again later.</div>';
                });
        }
        
        // Function to load following
        function loadFollowing() {
            fetch(`/api/users/${currentUserId}/following/`)
                .then(response => response.json())
                .then(users => {
                    displayUsers('followingList', users);
                })
                .catch(error => {
                    console.error('Error fetching following:', error);
                    document.getElementById('followingList').innerHTML = '<div class="col-12 text-center py-4">Error loading following. Please try again later.</div>';
                });
        }
        
        // Function to load discover users
        function loadDiscoverUsers() {
            fetch('/api/users/')
                .then(response => response.json())
                .then(data => {
                    displayUsers('discoverList', data.results || data, true);
                })
                .catch(error => {
                    console.error('Error fetching users:', error);
                    document.getElementById('discoverList').innerHTML = '<div class="col-12 text-center py-4">Error loading suggestions. Please try again later.</div>';
                });
        }
        
        // Function to search users
        function searchUsers(searchTerm) {
            document.getElementById('discoverList').innerHTML = `
                <div class="col-12 text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Searching for "${searchTerm}"...</p>
                </div>
            `;
            
            fetch(`/api/users/?search=${encodeURIComponent(searchTerm)}`)
                .then(response => response.json())
                .then(data => {
                    displayUsers('discoverList', data.results || data, true);
                })
                .catch(error => {
                    console.error('Error searching users:', error);
                    document.getElementById('discoverList').innerHTML = '<div class="col-12 text-center py-4">Error searching users. Please try again later.</div>';
                });
        }
        
        // Function to display users in a grid
        function displayUsers(containerId, users, showFollowButton = false) {
            const container = document.getElementById(containerId);
            
            if (!users || users.length === 0) {
                container.innerHTML = '<div class="col-12 text-center py-4">No users found.</div>';
                return;
            }
            
            container.innerHTML = '';
            
            users.forEach(user => {
                if (user.id === currentUserId) {
                    return; // Skip current user
                }
                
                const col = document.createElement('div');
                col.className = 'col-md-4 mb-4';
                
                const card = document.createElement('div');
                card.className = 'card h-100';
                
                const cardBody = document.createElement('div');
                cardBody.className = 'card-body text-center';
                
                const img = document.createElement('img');
                img.src = user.profile_picture || '{% static "img/default-avatar.png" %}';
                img.className = 'rounded-circle mb-3';
                img.alt = 'Profile Picture';
                img.style = 'width: 80px; height: 80px; object-fit: cover;';
                
                const title = document.createElement('h5');
                title.className = 'card-title mb-0';
                title.textContent = user.nickname || user.username;
                
                const username = document.createElement('p');
                username.className = 'text-muted small';
                username.textContent = '@' + user.username;
                
                const stats = document.createElement('div');
                stats.className = 'd-flex justify-content-around mt-2';
                const statsHtml = `
                    <div>
                        <span class="fw-bold">${user.followers_count || 0}</span>
                        <small class="d-block text-muted">Followers</small>
                    </div>
                    <div>
                        <span class="fw-bold">${user.following_count || 0}</span>
                        <small class="d-block text-muted">Following</small>
                    </div>
                `;
                stats.innerHTML = statsHtml;
                
                cardBody.appendChild(img);
                cardBody.appendChild(title);
                cardBody.appendChild(username);
                cardBody.appendChild(stats);
                
                const cardFooter = document.createElement('div');
                cardFooter.className = 'card-footer bg-transparent border-top-0 d-flex justify-content-between';
                
                // View profile button
                const viewButton = document.createElement('a');
                viewButton.href = `/users/profile/${user.username}`;
                viewButton.className = 'btn btn-sm btn-outline-secondary';
                viewButton.innerHTML = '<i class="fas fa-user me-1"></i> Profile';
                
                cardFooter.appendChild(viewButton);
                
                // Follow/Unfollow button
                if (showFollowButton) {
                    const followButton = document.createElement('button');
                    followButton.className = user.is_following ? 'btn btn-sm btn-primary' : 'btn btn-sm btn-outline-primary';
                    followButton.innerHTML = user.is_following ? '<i class="fas fa-user-minus me-1"></i> Unfollow' : '<i class="fas fa-user-plus me-1"></i> Follow';
                    followButton.setAttribute('data-user-id', user.id);
                    followButton.setAttribute('data-following', user.is_following ? 'true' : 'false');
                    
                    followButton.addEventListener('click', function() {
                        const userId = this.getAttribute('data-user-id');
                        followUser(userId, this);
                    });
                    
                    cardFooter.appendChild(followButton);
                }
                
                card.appendChild(cardBody);
                card.appendChild(cardFooter);
                col.appendChild(card);
                container.appendChild(col);
            });
        }
        
        // Function to follow/unfollow user
        function followUser(userId, button) {
            fetch(`/api/users/${userId}/follow/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                }
            })
            .then(response => response.json())
            .then(data => {
                const isFollowing = data.status === 'following';
                button.className = isFollowing ? 'btn btn-sm btn-primary' : 'btn btn-sm btn-outline-primary';
                button.innerHTML = isFollowing ? '<i class="fas fa-user-minus me-1"></i> Unfollow' : '<i class="fas fa-user-plus me-1"></i> Follow';
                button.setAttribute('data-following', isFollowing ? 'true' : 'false');
                
                // Update follower count on the page
                updateFollowCounts();
                
                // Refresh network visualization
                initializeNetwork();
            })
            .catch(error => {
                console.error('Error following user:', error);
                alert('Error following user. Please try again later.');
            });
        }
        
        // Function to update follower and following counts
        function updateFollowCounts() {
            fetch(`/api/users/${currentUserId}/`)
                .then(response => response.json())
                .then(user => {
                    document.getElementById('followersCount').textContent = user.followers_count;
                    document.getElementById('followingCount').textContent = user.following_count;
                })
                .catch(error => {
                    console.error('Error updating counts:', error);
                });
        }
        
        // Function to initialize network visualization
        function initializeNetwork() {
            const container = document.getElementById('networkVisualization');
            container.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Loading network...</p></div>';
            
            // Fetch network data
            Promise.all([
                fetch(`/api/users/${currentUserId}/followers/`).then(response => response.json()),
                fetch(`/api/users/${currentUserId}/following/`).then(response => response.json())
            ])
            .then(([followers, following]) => {
                // Create nodes and edges for the network
                const nodes = [];
                const edges = [];
                const nodeIds = new Set();
                
                // Add current user
                nodes.push({
                    id: currentUserId,
                    label: currentUserNickname,
                    shape: 'circularImage',
                    image: currentUserProfilePicture,
                    size: 40,
                    font: { size: 16, face: 'Segoe UI' },
                    color: { border: '#0d6efd', background: '#ffffff' }
                });
                nodeIds.add(currentUserId);
                
                // Add followers
                followers.forEach(follower => {
                    if (!nodeIds.has(follower.id)) {
                        nodes.push({
                            id: follower.id,
                            label: follower.nickname || follower.username,
                            shape: 'circularImage',
                            image: follower.profile_picture || '/static/img/default-avatar.png',
                            size: 30,
                            font: { size: 12, face: 'Segoe UI' }
                        });
                        nodeIds.add(follower.id);
                    }
                    
                    // Edge from follower to current user
                    edges.push({
                        from: follower.id,
                        to: currentUserId,
                        arrows: 'to',
                        color: { color: '#6c757d' },
                        width: 1.5
                    });
                });
                
                // Add following
                following.forEach(follow => {
                    if (!nodeIds.has(follow.id)) {
                        nodes.push({
                            id: follow.id,
                            label: follow.nickname || follow.username,
                            shape: 'circularImage',
                            image: follow.profile_picture || '/static/img/default-avatar.png',
                            size: 30,
                            font: { size: 12, face: 'Segoe UI' }
                        });
                        nodeIds.add(follow.id);
                    }
                    
                    // Edge from current user to followed user
                    edges.push({
                        from: currentUserId,
                        to: follow.id,
                        arrows: 'to',
                        color: { color: '#0d6efd' },
                        width: 1.5
                    });
                });
                
                // Check if no connections
                if (nodes.length === 1) {
                    container.innerHTML = '<div class="text-center py-4"><p>You don\'t have any connections yet. Start following people to build your network!</p></div>';
                    return;
                }
                
                container.innerHTML = '';
                
                // Create network
                const data = {
                    nodes: new vis.DataSet(nodes),
                    edges: new vis.DataSet(edges)
                };
                
                const options = {
                    nodes: {
                        borderWidth: 2,
                        shadow: true
                    },
                    edges: {
                        smooth: {
                            type: 'continuous'
                        }
                    },
                    physics: {
                        stabilization: true,
                        barnesHut: {
                            gravitationalConstant: -2000,
                            centralGravity: 0.3,
                            springLength: 150,
                            springConstant: 0.04
                        }
                    },
                    interaction: {
                        navigationButtons: true,
                        keyboard: true
                    }
                };
                
                const network = new vis.Network(container, data, options);
                
                // Add click event for nodes
                network.on('click', function(params) {
                    if (params.nodes.length > 0) {
                        const nodeId = params.nodes[0];
                        // Get node info
                        const node = nodes.find(n => n.id === nodeId);
                        if (node && nodeId !== currentUserId) {
                            // Navigate to user profile on click
                            fetch(`/api/users/${nodeId}/`)
                                .then(response => response.json())
                                .then(user => {
                                    window.location.href = `/users/profile/${user.username}`;
                                })
                                .catch(error => {
                                    console.error('Error fetching user:', error);
                                });
                        }
                    }
                });
            })
            .catch(error => {
                console.error('Error loading network data:', error);
                container.innerHTML = '<div class="text-center py-4">Error loading network visualization. Please try again later.</div>';
            });
        }
        
        // Helper function to get CSRF token
        function getCsrfToken() {
            const csrfCookie = document.cookie.split(';')
                .find(cookie => cookie.trim().startsWith('csrftoken='));
            
            if (csrfCookie) {
                return csrfCookie.split('=')[1];
            }
            
            // If no cookie found, try to find the token in a meta tag
            const csrfMeta = document.querySelector('meta[name="csrf-token"]');
            if (csrfMeta) {
                return csrfMeta.getAttribute('content');
            }
            
            return '';
        }
    </script>
</body>
</html> 